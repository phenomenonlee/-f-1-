<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>music comment</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <link href="../static/index.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&amp;display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <style>
        * {
            font-family: 'Gowun Dodum', sans-serif;
        }

        .mainImage {

            max-width: 1000px;
            margin: 0 auto 0 auto;
        }

        #ripple{
            margin-bottom: 15px;
        }

        .content {
            margin-top: 30px;
            border-style: solid;
            border-color: gray;
            max-width: 1000px;
        }

        .picture-box {
            width: 500px;
            height: 500px;
        }

        .card {
            margin-top: 20px;
            max-width: 800px;
        }

        .main {
            border-style: double;
            color: black;

            width: 150px;
            font-size: 30px;

        }

        .comments {
            position: relative;
            margin-bottom: 200px;
            min-width: 500px;
            max-width: 800px;
        }

        .textarea {
            min-width: 500px;
            max-width: 800px;
        }

        .button {
            width: 80px;
        }
        .ripple_box{
            display :flex;
            justify-content: space-between;

        }
        .nickname{

            color: white;

        }
        .nickBorder{
            border-bottom-style: solid;
            border-width: 2px;
            border-bottom-color: black;

        }
        .ripple_del_btn{
            width: 20px;
            height: 20px;

            margin: 5px 5px 0 0;

        }
        .del_X{
            width: 10px;
            height: 10px;
            position: relative;
            right: 5px;
            bottom: 8px;
        }

    </style>
    <script>
        $(document).ready(function () {
            detail_info(), show_ripple(), check_cookie()
        });

        function check_cookie() {
            $.ajax({
                type: "GET",
                url: "/cookie",
                data: {},
                success: function (response) {
                    let cookie = response['cookie']
                    if (cookie == "정상") {
                        return
                    }
                    if (cookie == "만료") {
                        $.removeCookie('mytoken');
                        window.location.href = '/login';
                        alert('로그인 기한이 만료되었습니다.')
                        return
                    }
                    if (cookie == "없음") {
                        window.location.href = '/login';
                        alert('로그인이 필요합니다!.')
                        return
                    }
                }
            })
        }
        function delete_ripple(index){
            console.log(index)
             $.ajax({
                 type: "POST",
                 url: `/detail/delete_ripple`,
                 data: {'index_give': index},
                 success: function (response) {
                     window.location.reload()
                     alert(response['msg'])
                 }
             })
        }

        //노래 정보 가지고 오기
        function detail_info() {
            let detail = {{detail}}
            $.ajax({
                type: "GET",
                url: `/detail/info?detail=${detail}`,
                data: {},
                success: function (response) {
                    let rows = response['result']


                    let id = rows['id']
                    let title = rows['title']
                    let desc = rows['desc']
                    let url = rows['url']
                    if (url == "") {
                        url = "http://image.genie.co.kr/Y/IMAGE/IMG_ALBUM/080/969/543/80969543_1500880366913_1_600x600.JPG"
                    }

                    let temp_html = `<div class="content">
                      <img class="picture-box" src= ${url} alt="">
                      <div class="card">
                        <div class="card-header">
                          ${id}
                        </div>
                        <div class="card-body">
                          <blockquote class="blockquote mb-0">
                            <p>${title}</p>
                            <footer class="blockquote-footer"> <cite title="Source Title">${desc}</cite></footer>
                          </blockquote>
                        </div>

                      </div>
                    </div>`
                    $('#cards-box').append(temp_html)
                }
            });
        }

        // 상세페이지에 댓글 보여주기
        function show_ripple() {
            let detail = {{detail}}
            $.ajax({
                type: "GET",
                url: `/detail/ripple?detail=${detail}`,
                data: {},
                success: function (response) {
                    let rows = response['result']
                    for (let i = 0; i < rows.length; i++){
                    let user_id = response['id']
                    let id = rows[i]['id']
                    let ripple = rows[i]['desc']
                    if(rows[i]['ripple_index'] == undefined){
                        continue
                    }
                        let ripple_index = rows[i]['ripple_index']
                     let temp_html
                    if(user_id == id){
                         temp_html =
                        `<div class="card text-white bg-secondary mb-3">
                                <div class = 'ripple_box nickBorder'  >
                                <div class="card-header  nickname" style="color : white" >${id}</div>
                                <button type="button"  onclick="delete_ripple(${ripple_index})" class="btn btn-danger ripple_del_btn"><span class="del_X">X</span></button>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">${ripple}</p>
                                </div>

                            </div>`
                    }else{
                          temp_html =
                        `<div class="card text-white bg-secondary mb-3">
                                <div class = 'ripple_box nickBorder'  >
                                <div class="card-header  nickname" style="color : white" >${id}</div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">${ripple}</p>
                                </div>

                            </div>`
                    }



                        $('#ripple-box').append(temp_html)
                    }
                }
            });
        }

        // 상세페이지에서 단 댓글을 저장
        function save_ripple() {
            let desc = $('#ripple').val()
            let detail = {{detail}}

            $.ajax({
                type: 'POST',
                url: `/detail/ripple?detail=${detail}`,
                data: {
                    ripple_give: desc,
                },
                success: function (response) {
                    window.location.reload()
                }
            });
        };

        function logout() {
            $.removeCookie('mytoken');
            window.location.href = '/'
        }

    </script>

</head>
<body>


<main>

    <div id="header">

    </div>
    <center>
        <div class="content" id="cards-box">

        </div>
        <textarea class="textarea" id="ripple" placeholder="감상평을 작성해 주세요"></textarea>
        <div class="button">
            <button onclick="save_ripple()" class="button is-primary">작성하기</button>
        </div>
        <div class="comments" id="ripple-box">

        </div>

    </center>
</main>

<div id="footer">

</div>

<script>
    $(document).ready(function () {
        $("#header").load("/header");  // 원하는 파일 경로를 삽입하면 된다
        $("#footer").load("/footer");  // 추가 인클루드를 원할 경우 이런식으로 추가하면 된다
    });
</script>
</body>
</html>